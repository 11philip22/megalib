# C++ SDK Inventory (MEGA SDK)

## SDK Root
- `sdk/` (contains `include/`, `src/`, `bindings/`, `tests/`, etc.)

## Inventory Table

| Subsystem | C++ files | Key classes | Key methods | Invariants / assumptions |
| --- | --- | --- | --- | --- |
| Public API facade | `sdk/include/megaapi.h`, `sdk/include/megaapi_impl.h`, `sdk/src/megaapi.cpp`, `sdk/src/megaapi_impl.cpp`, `sdk/src/megaapi_impl_sync.cpp` | `MegaApi`, `MegaApiImpl`, `MegaApiLock`, `MegaRequest`, `MegaTransfer`, `MegaNode`, `MegaUser`, `MegaError` | `MegaApi::login`, `MegaApi::fetchNodes`, `MegaApi::logout`, `MegaApi::startUpload`, `MegaApi::startDownload`, `MegaApi::exportNode`, `MegaApi::createAccount` | Usage contract: login then `fetchNodes` before filesystem ops; many methods return ownership via `new`/`new[]` (caller must delete). |
| Core client engine | `sdk/include/mega/megaclient.h`, `sdk/src/megaclient.cpp`, `sdk/include/mega/megaapp.h` | `MegaClient`, `MegaApp` | `MegaClient::login`, `MegaClient::dumpsession`, `MegaClient::fetchnodes`, `MegaClient::logout` | Client holds session state, node cache, transfer queues, and request dispatcher; retry/backoff managed via `BackoffTimer` across CS and transfers. |
| Request / command pipeline | `sdk/include/mega/command.h`, `sdk/src/command.cpp`, `sdk/src/commands.cpp`, `sdk/include/mega/request.h`, `sdk/src/request.cpp` | `Command`, `Request`, `RequestDispatcher` | `Command::procresult`, `Request::get`, `RequestDispatcher::serverrequest`, `RequestDispatcher::serverresponse` | Request batching with `MAX_COMMANDS`; `Command::batchSeparately` forces isolation; retries must reuse cached JSON/idempotence token. |
| HTTP / network I/O | `sdk/include/mega/http.h`, `sdk/src/http.cpp`, `sdk/src/mega_http_parser.cpp` | `HttpReq`, `HttpIO` (and related) | `HttpReq::post`, `HttpIO::post` (via platform impls) | TLS key pinning constants for API/chat/SFU; backoff and retry reasons handled at client/request layer. Timeouts: UNKNOWN (platform-specific). |
| Node model + node manager | `sdk/include/mega/node.h`, `sdk/src/node.cpp`, `sdk/include/mega/nodemanager.h`, `sdk/src/nodemanager.cpp` | `Node`, `NodeCore`, `NewNode`, `PublicLink`, `NodeManager`, `NodeData` | `Node::nodekey`, `Node::keyApplied`, `Node::applykey`, `Node::setattr`, `Node::decryptattr`, `NodeManager::getNode`, `NodeManager::unserializeNode`, `NodeManager::applyKeys` | Node handles are 6 bytes; `Node::nodekey()` asserts `keyApplied()` for non-root nodes; `keyApplied` means key length == file/folder key length; attributes decrypt via AES-CBC of base64 and must start with `MEGA{\"`; compound keys encode `userhandle:` or `sharenode:` segments; share key source is `KeyManager` (if migrated) else new-key repo or share root node; foreign share key failure restores undecrypted key for later retry; `NodeManager` keeps root/first-level/notify nodes in RAM, otherwise writes to DB and loads on demand; incoming shares are loaded on `mergenewshares` after `fetchnodes`; pending apply-keys queue drained by `applyKeys`. |
| Filesystem + local file model | `sdk/include/mega/file.h`, `sdk/src/file.cpp`, `sdk/include/mega/filesystem.h`, `sdk/src/filesystem.cpp`, `sdk/include/mega/filefingerprint.h`, `sdk/src/filefingerprint.cpp`, `sdk/include/mega/localpath.h` | `File`, `FileFingerprint`, `LocalPath`, `FileSystemAccess`, `FSNode`, `fsfp_t`, `fsfp_tracker_t`, `FileDistributor` | `FileSystemAccess::fsFingerprint`, `FileSystemAccess::fsStableIDs`, `FileSystemAccess::directoryScan`, `FSNode::fromPath`, `FileDistributor::moveTo/copyTo` | Filesystem fingerprint includes legacy `fingerprint` + UUID; `fsfp_tracker_t` tracks ref-counted fingerprints; `LocalPath` abstracts platform encoding + URI paths (UTF-16 on Windows, UTF-8 elsewhere); sync depends on stable fs IDs (`fsStableIDs`) and `fsidOf`; `FileDistributor` resolves name collisions via rename/copy strategies (bracketed numbers, oldN, overwrite, debris). |
| Transfers | `sdk/include/mega/transfer.h`, `sdk/src/transfer.cpp`, `sdk/include/mega/transferslot.h`, `sdk/src/transferslot.cpp`, `sdk/include/mega/transferstats.h`, `sdk/src/transferstats.cpp` | `Transfer`, `TransferSlot`, `TransferCategory` | `Transfer::failed`, `Transfer::complete`, `Transfer::serialize`, `Transfer::transfercipher` | Transfers are keyed by `FileFingerprint`; temp URLs can be cached and expire; chunk MACs and meta MAC used for upload completion; retry/backoff via `BackoffTimer`. |
| Sync engine | `sdk/include/mega/sync.h`, `sdk/src/sync.cpp`, `sdk/include/mega/syncfilter.h`, `sdk/src/syncfilter.cpp`, `sdk/src/syncinternals/*` | `SyncConfig`, `LocalNode`, `Sync` (and internals) | `SyncConfig::setEnabled`, `SyncConfig::getSyncDbStateCacheName` | Sync uses filesystem change detection (notifications vs periodic); external backup syncs require matching external drive path; local fsid is persisted and must remain stable. |
| Sharing / public links | `sdk/include/mega/share.h`, `sdk/src/share.cpp`, `sdk/include/mega/sharenodekeys.h`, `sdk/src/sharenodekeys.cpp`, `sdk/include/mega/node.h`, `sdk/include/megaapi.h`, `sdk/src/megaapi_impl.cpp`, `sdk/src/megaclient.cpp`, `sdk/src/commands.cpp` | `Share`, `NewShare`, `ShareNodeKeys`, `PublicLink`, `MegaNode` | `MegaApi::exportNode`, `MegaApi::disableExport`, `MegaApi::getPublicNode`, `MegaApi::loginToFolder`, `MegaApi::buildPublicLink`, `MegaClient::setshare`, `MegaClient::exportnode`, `MegaClient::parsepubliclink`, `MegaClient::openfilelink`, `ShareNodeKeys::add/get`, `CommandPutNodes` | Exported nodes (public links) are not considered shared nodes; folder links require a share key (generated if missing or reused from KeyManager), and the share key is flagged INUSE when share is active; file links use node key, folder links use share key; `exportnode` returns `API_EKEY` if required key missing; writable links include auth key; link format uses `mNewLinkFormat` in `publicLinkURL`; when adding new nodes under an exported folder, `CommandPutNodes` builds a `cr` element via `ShareNodeKeys` that encrypts each new node key with the share key of any share in the parent chain (including the exported folder), so existing public links continue to decrypt newly added files without regenerating the link. |
| Key management (^!keys) | `sdk/include/mega/megaclient.h` (KeyManager), `sdk/src/megaclient.cpp`, `sdk/src/tlv.cpp` | `KeyManager` | `init`, `setKey`, `fromKeysContainer`, `toKeysContainer`, `commit`, `updateAttribute`, `promotePendingShares`, `encryptShareKeyTo`, `decryptShareKeyFrom`, `computeSymmetricKey` | ^!keys header bytes are `{20,0}`; container uses AES-GCM with HKDF-derived key (info byte = 1) from master key; generation is serialized as big-endian `gen+1`; Ed25519/Cu25519 private keys are fixed-length; RSA private key is empty or >=512 bytes; pending outshares encode uid length (0=user handle, non-zero=email); warnings/pending-in use LTLV; downgrade detection sets `mDowngradeAttack` and blocks commits. Share key replacement is rejected if existing key is trusted; manual verification gates share-key encryption/decryption. |
| Authring validation | `sdk/include/mega/user.h`, `sdk/src/megaclient.cpp` | `AuthRing` | `MegaClient::trackKey`, `MegaClient::trackSignature`, `MegaClient::updateAuthring`, `MegaClient::verifyCredentials`, `AuthRing::add`, `AuthRing::update`, `AuthRing::areCredentialsVerified` | Fingerprint mismatch triggers `key_modified` and `API_EKEY`; Cu25519 signatures must verify with Ed25519 signing key; Ed25519 authring uses `AUTH_METHOD_SEEN/FINGERPRINT`; Cu25519 authring uses `AUTH_METHOD_SIGNATURE`; authring updates are buffered in `mAuthRingsTemp` during initial contact-key scan, then persisted via ^!keys commit if account migrated, else stored locally. |
| Crypto primitives | `sdk/include/mega/crypto/cryptopp.h`, `sdk/src/crypto/cryptopp.cpp`, `sdk/include/mega/crypto/sodium.h`, `sdk/src/crypto/sodium.cpp` | `SymmCipher`, `AsymmCipher`, `Hash`, `HashSHA256`, `HashCRC32`, `HMACSHA256`, `PBKDF2_HMAC_SHA512`, `EdDSA`, `ECDH` | `SymmCipher::setkey`, `cbc_encrypt/decrypt`, `gcm_encrypt/decrypt`, `ccm_encrypt/decrypt`, `ctr_crypt`, `isZeroKey`; `AsymmCipher::setkey`, `isvalid`, `serializekeyforjs`, `genkeypair`; `EdDSA::sign/verify/verifyKey`; `ECDH::computeSymmetricKey`, `deriveSharedKeyWithSalt`, `encrypt/decrypt` | Symmetric AES-128 (key length 16) supports ECB/CBC/CTR/CCM/GCM; CBC IV is 16 bytes; GCM/CCM IV length allowed 7–13 bytes and decryption expects tag sizes 4/8/16 (GCM) or 8/16 (CCM); `SymmCipher::setkey(string)` only accepts 16/32-byte node keys; `setkey(type=0)` XORs second half into first; `ctr_crypt` requires block-aligned positions; `isZeroKey` only supports 16/32-byte keys (32-byte “zero” means halves match); RSA validity checks guard against corrupted keys (bitcount thresholds and `u == p^-1 mod q`); `serializekeyforjs` pads exponent to 4 bytes for webclient compatibility; Ed25519 `verifyKey` signs/verifies `keyauth + timestamp + pubkey` (signature size >= 72); X25519 `deriveSharedKeyWithSalt` applies HKDF-SHA256 over shared secret + salt; ECDH encrypt/decrypt require unique nonces and crypto_box zero-prefix padding. |
| User/accounts + attributes | `sdk/include/mega/user.h`, `sdk/src/user.cpp`, `sdk/include/mega/user_attribute*.h`, `sdk/src/user_attribute*.cpp`, `sdk/include/mega/account.h` | `User`, `UserAttributeManager`, `UserAttribute` | `MegaApi::getUserAttribute`, `MegaApi::setUserAttribute` (public API), `UserAttributeManager::fetch` (implied) | User attributes include authrings, keyring, avatar, etc. Versioned/private/public scopes enforced by attribute type. |
| Logging + diagnostics | `sdk/include/mega/logging.h`, `sdk/src/logging.cpp`, `sdk/include/mega/log_level.h` | `Logger` (and helpers) | `setLogLevel`, `log` (implied) | Logging is globally scoped; verbose logs gated by build flags. |

## Behavior-Critical Paths And State Machines

- Authentication and session bootstrap: `MegaApi::login` -> `MegaClient::login` -> session key + SID establishment; `MegaApi::fetchNodes` required before node operations. (`sdk/include/megaapi.h`, `sdk/include/mega/megaclient.h`, `sdk/src/megaclient.cpp`)
- Request batching / idempotence: `RequestDispatcher` builds batches, caches JSON for retries, enforces `batchSeparately`. (`sdk/include/mega/request.h`, `sdk/src/request.cpp`)
- Command execution: `Command::procresult` parses API replies; command classes in `commands.cpp` implement specific actions. (`sdk/include/mega/command.h`, `sdk/src/commands.cpp`)
- Node parsing and key application: `Node::applykey` selects compound key segment, decrypts via `decryptkey`, then `Node::setattr` (AES-CBC base64, `MEGA{\"` prefix); if foreign share key fails, encrypted key is retained for later retry. (`sdk/include/mega/node.h`, `sdk/src/node.cpp`)
- Node cache + DB boundary: `NodeManager::addNode_internal` keeps only root/first-level/notify nodes in RAM during fetch, others go to DB; incoming shares loaded on `mergenewshares`. (`sdk/src/nodemanager.cpp`)
- Node key application queue: `NodeManager::addNodePendingApplykey` + `applyKeys_internal` drain pending nodes until `applykey` succeeds or key arrives. (`sdk/src/nodemanager.cpp`)
- Transfer pipeline: `Transfer` + `TransferSlot` manage chunking, temp URLs, MACs, progress, and retries/backoff. (`sdk/include/mega/transfer.h`, `sdk/src/transfer.cpp`, `sdk/src/transferslot.cpp`)
- Upload completion: `Transfer::filekey`, `metamac`, `chunkmacs` used to finalize node creation and attributes. (`sdk/include/mega/transfer.h`, `sdk/src/transfer.cpp`)
- Download path: `Transfer` + HTTP fetch, decryption, and resume logic. (Exact resume invariants: UNKNOWN)
- Retry/backoff: `MegaClient` and `RequestDispatcher` use `BackoffTimer` for CS, transfers, and file-attribute requests. (`sdk/src/megaclient.cpp`, `sdk/src/request.cpp`)
- Sync engine: `SyncConfig` + sync internals manage state, scanning, conflict resolution, and database persistence. (`sdk/include/mega/sync.h`, `sdk/src/sync.cpp`, `sdk/src/syncinternals/*`)
- Key management: `KeyManager::fromKeysContainer` -> `isValidKeysContainer` -> `updateValues` -> optional `promotePendingShares` -> `commit` queue -> `updateAttribute` (PUT `^!keys`), with retry on version clash (`API_EEXPIRED`) by refetching ^!keys. Manual verification gates share-key encryption/decryption; verification is based on authring state. (`sdk/include/mega/megaclient.h`, `sdk/src/megaclient.cpp`)
- Post-login ^!keys import: after login, `fetchnodes()` queues `getuserdata` (`ug`), which loads `^!keys` via `KeyManager::fromKeysContainer`; `updateShareKeys` then `loadShareKeys` injects share/export keys into nodes (via `mergenewshare`) before normal operations proceed. (`sdk/src/megaclient.cpp`, `sdk/src/commands.cpp`)
- Share promotion: pending outshares encrypt share keys to recipients if `verificationRequired` false and send `CommandPendingKeys`; pending inshares decrypt keys (legacy base64 fix if size>16), add share key as trusted, and enqueue `NewShare` before `mergenewshares`. (`sdk/src/megaclient.cpp`)
- Authring validation: `trackKey` and `trackSignature` compute fingerprints and verify signatures; on mismatch, events `99451/99452` and `API_EKEY` returned; updates flow through `updateAuthring` and are persisted to ^!keys when migrated. (`sdk/src/megaclient.cpp`, `sdk/include/mega/user.h`)
- TLS pinning: HTTP layer embeds pinned public keys for API/chat/SFU. (`sdk/include/mega/http.h`)
- Sharing/public links: `MegaClient::setshare` generates or reuses share keys, updates ^!keys and pending outshares before issuing `CommandSetShare`; `exportNode` uses `exportnode` to create link and builds URL from node key/share key; `getPublicNode` parses link and opens file link (without key if missing). (`sdk/src/megaclient.cpp`, `sdk/src/megaapi_impl.cpp`)
- Exported folder updates: `CommandPutNodes` emits `cr` via `ShareNodeKeys` to re-wrap new node keys for each share in the parent chain (including exported folders), keeping existing public links valid as new files are added. (`sdk/src/commands.cpp`, `sdk/src/sharenodekeys.cpp`)
- Filesystem identity and paths: `fsFingerprint`/`fsStableIDs` guard sync identity; `LocalPath` provides platform/URI abstraction; `FSNode::fromPath` drives scanning and metadata collection; `FileDistributor` decides rename/copy resolution for clashes. (`sdk/include/mega/filesystem.h`, `sdk/include/mega/localpath.h`)
- Crypto invariants for auth and key material: Ed25519 keyauth signatures (`keyauth + ts + pubkey`), RSA validity checks, AES GCM/CCM IV/tag size constraints, and X25519 HKDF-derived shared keys. (`sdk/include/mega/crypto/cryptopp.h`, `sdk/src/crypto/cryptopp.cpp`, `sdk/include/mega/crypto/sodium.h`, `sdk/src/crypto/sodium.cpp`)

## Gaps / Unknowns
- Exact request signing details (beyond SID and idempotence): UNKNOWN.
- Precise timeout defaults per HTTP implementation and per platform: UNKNOWN.
- Exact transfer resume semantics and temp file naming at C++ layer: UNKNOWN.
